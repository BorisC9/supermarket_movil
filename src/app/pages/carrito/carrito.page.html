<ion-header class="ion-no-border">
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-back-button defaultHref="/productos" text="" class="back-btn"></ion-back-button>
        </ion-buttons>
        <ion-title>
            <div class="header-title">
                <span class="title-main">Mi Carrito</span>
                <span class="title-sub">{{ carrito().items.length }} productos</span>
            </div>
        </ion-title>
        @if (carrito().items.length > 0) {
        <ion-buttons slot="end">
            <ion-button (click)="limpiarCarrito()" class="clear-btn">
                <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
        </ion-buttons>
        }
    </ion-toolbar>
</ion-header>

<ion-content>
    @if (carrito().items.length === 0) {
    <div class="empty-state">
        <div class="empty-icon-container">
            <ion-icon name="cart-outline"></ion-icon>
        </div>
        <h2>Tu carrito está vacío</h2>
        <p>Agrega productos para comenzar tu compra</p>
        <ion-button class="primary-btn" (click)="continuarComprando()">
            <ion-icon slot="start" name="storefront-outline"></ion-icon>
            Ver Productos
        </ion-button>
    </div>
    } @else {
    <div class="cart-items">
        @for (item of carrito().items; track getProductoId(item.producto)) {
        <div class="cart-item animate-in">
            <div class="item-image">
                <img [src]="getProductoImagen(item.producto) || 'assets/imgs/placeholder.png'"
                    [alt]="getProductoNombre(item.producto)" (error)="onImageError($event)" />
            </div>

            <div class="item-details">
                <h4 class="item-name">{{ getProductoNombre(item.producto) }}</h4>
                <p class="item-price-unit">${{ calcularPrecioFinal(item.producto).toFixed(2) }} c/u</p>

                <div class="item-bottom">
                    <div class="quantity-control">
                        <button class="qty-btn"
                            (click)="decrementarCantidad(getProductoId(item.producto), item.cantidad)">
                            <ion-icon name="remove"></ion-icon>
                        </button>
                        <span class="quantity">{{ item.cantidad }}</span>
                        <button class="qty-btn"
                            (click)="incrementarCantidad(getProductoId(item.producto), item.cantidad)"
                            [disabled]="item.cantidad >= getProductoStock(item.producto)">
                            <ion-icon name="add"></ion-icon>
                        </button>
                    </div>
                    <span class="item-total">${{ item.total.toFixed(2) }}</span>
                </div>
            </div>

            <button class="delete-btn" (click)="eliminarItem(getProductoId(item.producto))">
                <ion-icon name="close"></ion-icon>
            </button>
        </div>
        }
    </div>

    <!-- Resumen del carrito -->
    <div class="summary-card">
        <h3 class="summary-title">Resumen de Compra</h3>

        <div class="summary-row">
            <span>Subtotal</span>
            <span>${{ carrito().subtotal.toFixed(2) }}</span>
        </div>

        @if (carrito().descuentoTotal > 0) {
        <div class="summary-row discount">
            <span>Descuentos</span>
            <span>-${{ carrito().descuentoTotal.toFixed(2) }}</span>
        </div>
        }

        <div class="summary-divider"></div>

        <div class="summary-row total">
            <span>Total</span>
            <span>${{ carrito().total.toFixed(2) }}</span>
        </div>
    </div>
    }
</ion-content>

@if (carrito().items.length > 0) {
<ion-footer class="ion-no-border">
    <div class="footer-content">
        <div class="footer-total">
            <span class="footer-label">Total a pagar</span>
            <span class="footer-price">${{ carrito().total.toFixed(2) }}</span>
        </div>
        <ion-button class="checkout-btn" expand="block" (click)="procederAlCheckout()">
            Continuar
            <ion-icon slot="end" name="arrow-forward"></ion-icon>
        </ion-button>
    </div>
</ion-footer>
}