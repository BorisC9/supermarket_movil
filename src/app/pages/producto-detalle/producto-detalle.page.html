<ion-header class="ion-no-border">
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-back-button defaultHref="/productos" text="" class="back-btn"></ion-back-button>
        </ion-buttons>
        <ion-title>
            <span class="header-title-text">Detalle</span>
        </ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="irAlCarrito()" class="cart-btn">
                <ion-icon slot="icon-only" name="cart-outline"></ion-icon>
                @if (carritoService.cantidadTotal() > 0) {
                <span class="cart-badge">{{ carritoService.cantidadTotal() }}</span>
                }
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content>
    @if (cargando()) {
    <div class="loading-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Cargando producto...</p>
    </div>
    } @else if (producto()) {
    <div class="producto-detalle">
        <!-- Imagen principal -->
        <div class="imagen-container">
            <img [src]="getImageUrl(producto()!)" [alt]="getNombre(producto()!)" (error)="onImageError($event)" />
            @if (getDescuento(producto()!) > 0) {
            <span class="discount-badge">-{{ getDescuento(producto()!) }}%</span>
            }
        </div>

        <!-- Información del producto -->
        <div class="info-container">
            <!-- Categoría y Marca -->
            <div class="tags-row">
                <span class="tag primary">{{ getCategoria(producto()!) }}</span>
                <span class="tag secondary">{{ getMarca(producto()!) }}</span>
            </div>

            <!-- Título -->
            <h1 class="product-title">{{ getNombre(producto()!) }}</h1>

            <!-- Precios -->
            <div class="price-section">
                @if (getDescuento(producto()!) > 0) {
                <div class="price-with-discount">
                    <span class="original-price">S/ {{ getPrecio(producto()!) }}</span>
                    <span class="current-price">S/ {{ getPrecioConDescuento(producto()!) }}</span>
                    <span class="savings">Ahorras S/ {{ calcularAhorro(producto()!) }}</span>
                </div>
                } @else {
                <span class="current-price">S/ {{ getPrecio(producto()!) }}</span>
                }
            </div>

            <!-- Estado del stock -->
            <div class="stock-badge" [class]="getStockStatus(producto()!).color">
                <ion-icon [name]="getStockStatus(producto()!).icon"></ion-icon>
                <span>{{ getStockStatus(producto()!).texto }}</span>
            </div>

            <!-- Información del producto -->
            <div class="info-card">
                <h3 class="info-card-title">Información del Producto</h3>

                <div class="info-row">
                    <div class="info-icon">
                        <ion-icon name="barcode-outline"></ion-icon>
                    </div>
                    <div class="info-content">
                        <span class="info-label">Código de Barras</span>
                        <span class="info-value">{{ getCodigoBarras(producto()!) }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-icon">
                        <ion-icon name="cube-outline"></ion-icon>
                    </div>
                    <div class="info-content">
                        <span class="info-label">Stock Disponible</span>
                        <span class="info-value">{{ getStock(producto()!) }} unidades</span>
                    </div>
                </div>
            </div>

            <!-- Descripción -->
            <div class="info-card">
                <h3 class="info-card-title">Descripción</h3>
                <p class="description-text">{{ getDescripcion(producto()!) }}</p>
            </div>

            <!-- Selector de cantidad -->
            @if (getDisponible(producto()!)) {
            <div class="quantity-card">
                <div class="quantity-row">
                    <span class="quantity-label">Cantidad</span>
                    <div class="quantity-control">
                        <button class="qty-btn" (click)="decrementarCantidad()" [disabled]="cantidad() <= 1">
                            <ion-icon name="remove"></ion-icon>
                        </button>
                        <span class="quantity-value">{{ cantidad() }}</span>
                        <button class="qty-btn" (click)="incrementarCantidad()"
                            [disabled]="cantidad() >= getStock(producto()!)">
                            <ion-icon name="add"></ion-icon>
                        </button>
                    </div>
                </div>
                <div class="subtotal-row">
                    <span>Subtotal</span>
                    <span class="subtotal-value">S/ {{ calcularSubtotal(producto()!) }}</span>
                </div>
            </div>
            }

            <!-- Botones de acción -->
            <div class="action-buttons">
                <ion-button class="add-cart-btn" expand="block" [disabled]="!getDisponible(producto()!)"
                    (click)="agregarAlCarrito()">
                    <ion-icon slot="start" name="cart"></ion-icon>
                    Agregar al Carrito
                </ion-button>
                <ion-button class="continue-btn" expand="block" fill="clear" routerLink="/productos">
                    <ion-icon slot="start" name="arrow-back"></ion-icon>
                    Seguir Comprando
                </ion-button>
            </div>
        </div>
    </div>
    } @else {
    <div class="empty-state">
        <div class="empty-icon-container">
            <ion-icon name="alert-circle-outline"></ion-icon>
        </div>
        <h2>Producto no encontrado</h2>
        <p>El producto que buscas no existe o no está disponible</p>
        <ion-button class="primary-btn" routerLink="/productos">
            <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
            Volver a productos
        </ion-button>
    </div>
    }
</ion-content>