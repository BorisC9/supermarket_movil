<ion-header class="ion-no-border">
    <ion-toolbar>
        <ion-title>
            <div class="header-title">
                <span class="title-main">Tienda</span>
                <span class="title-sub">Encuentra lo que necesitas</span>
            </div>
        </ion-title>
        <ion-buttons slot="end">
            <ion-button (click)="irAlCarrito()" class="icon-btn">
                <ion-icon slot="icon-only" name="cart-outline"></ion-icon>
                @if (carritoService.cantidadTotal() > 0) {
                <span class="cart-badge">{{ carritoService.cantidadTotal() }}</span>
                }
            </ion-button>
            <ion-button (click)="irAlPerfil()" class="icon-btn">
                <ion-icon slot="icon-only" name="person-circle-outline"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>

    <!-- Barra de búsqueda moderna -->
    <ion-toolbar class="search-toolbar">
        <ion-searchbar placeholder="¿Qué estás buscando?" (ionInput)="buscarProductos($event)" [debounce]="500"
            mode="ios">
        </ion-searchbar>
    </ion-toolbar>
</ion-header>

<ion-content>
    <!-- Filtros activos -->
    @if (categoriaSeleccionada() || terminoBusqueda()) {
    <div class="active-filters">
        @if (categoriaSeleccionada()) {
        <div class="category-chip active" (click)="filtrarPorCategoria(null)">
            <span>{{ obtenerNombreCategoria() }}</span>
            <ion-icon name="close-circle"></ion-icon>
        </div>
        }
        @if (terminoBusqueda()) {
        <div class="category-chip active" (click)="limpiarBusqueda()">
            <span>"{{ terminoBusqueda() }}"</span>
            <ion-icon name="close-circle"></ion-icon>
        </div>
        }
    </div>
    }

    <!-- Categorías horizontales -->
    <div class="categories-section">
        <h3 class="section-title">Categorías</h3>
        <div class="categories-scroll">
            <div class="category-item" [class.active]="!categoriaSeleccionada()" (click)="filtrarPorCategoria(null)">
                <div class="category-icon-container" [class.active]="!categoriaSeleccionada()">
                    <ion-icon name="grid-outline"></ion-icon>
                </div>
                <span>Todas</span>
            </div>
            @for (categoria of categorias(); track getCategoriaId(categoria)) {
            <div class="category-item" [class.active]="categoriaSeleccionada() === getCategoriaId(categoria)"
                (click)="filtrarPorCategoria(getCategoriaId(categoria))">
                <div class="category-icon-container"
                    [class.active]="categoriaSeleccionada() === getCategoriaId(categoria)">
                    <ion-icon name="pricetag-outline"></ion-icon>
                </div>
                <span>{{ getCategoriaNombre(categoria) }}</span>
            </div>
            }
        </div>
    </div>

    <!-- Lista de productos -->
    <div class="products-section">
        <div class="section-header">
            <h3 class="section-title">Productos</h3>
            <span class="product-count">{{ productos().length }} items</span>
        </div>

        @if (cargando()) {
        <div class="loading-container">
            <ion-spinner name="crescent" color="primary"></ion-spinner>
        </div>
        } @else {
        <div class="products-grid">
            @for (producto of productos(); track getProductoId(producto)) {
            <div class="product-card animate-in" (click)="verDetalle(producto)">
                <div class="product-image-container">
                    <img [src]="getProductoImagen(producto) || 'assets/imgs/placeholder.png'"
                        [alt]="getProductoNombre(producto)" (error)="onImageError($event)" />
                </div>
                <div class="product-info">
                    <p class="product-category">{{ getProductoCategoria(producto) || 'Producto' }}</p>
                    <h4 class="product-name">{{ getProductoNombre(producto) }}</h4>
                    <div class="product-price-row">
                        <div class="price-info">
                            @if (getProductoDctoPromo(producto) > 0) {
                            <span class="price-original">${{ getProductoPrecioVenta(producto).toFixed(2) }}</span>
                            }
                            <span class="product-price">${{ calcularPrecioFinal(producto).toFixed(2) }}</span>
                        </div>
                        <ion-button class="add-to-cart-btn" size="small"
                            (click)="agregarAlCarrito(producto); $event.stopPropagation()"
                            [disabled]="getProductoStock(producto) <= 0">
                            <ion-icon slot="icon-only" name="add"></ion-icon>
                        </ion-button>
                    </div>
                </div>
            </div>
            } @empty {
            <div class="empty-state" style="grid-column: 1 / -1;">
                <ion-icon name="search-outline"></ion-icon>
                <h2>No hay productos</h2>
                <p>Intenta con otra búsqueda o categoría</p>
            </div>
            }
        </div>
        }
    </div>
</ion-content>